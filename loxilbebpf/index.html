<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://loxilb-io.github.io/loxilbdocs/loxilbebpf/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>eBPF internals - loxilb v0.9.1</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <link href="../stylesheets/extra.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-21G7NBL2BN"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', "G-21G7NBL2BN");
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">loxilb v0.9.1</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">How-To Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../run/" class="dropdown-item">How-To - build/run</a>
</li>
                                    
<li>
    <a href="../cmd/" class="dropdown-item">How-To - configuration</a>
</li>
                                    
<li>
    <a href="../kube-loxilb/" class="dropdown-item">How-To - kube-loxilb</a>
</li>
                                    
<li>
    <a href="../debugging/" class="dropdown-item">How-To - debug</a>
</li>
                                    
<li>
    <a href="../integrate_bgp_eng/" class="dropdown-item">How-To - loxilb with calico bgp</a>
</li>
                                    
<li>
    <a href="../standalone/" class="dropdown-item">How-To - loxilb in standalone mode</a>
</li>
                                    
<li>
    <a href="../api/" class="dropdown-item">How-To - loxilb Web-APIs</a>
</li>
                                    
<li>
    <a href="../ha-deploy/" class="dropdown-item">How-To - high-availability with loxilb</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Knowledge Base <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ebpf/" class="dropdown-item">What is eBPF</a>
</li>
                                    
<li>
    <a href="../lb/" class="dropdown-item">What is k8s service - load-balancer</a>
</li>
                                    
<li>
    <a href="../arch/" class="dropdown-item">Architecture in brief</a>
</li>
                                    
<li>
    <a href="../code/" class="dropdown-item">Code organization</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">eBPF internals</a>
</li>
                                    
<li>
    <a href="../nat/" class="dropdown-item">NAT Modes of loxilb</a>
</li>
                                    
<li>
    <a href="../lb-algo/" class="dropdown-item">loxilb load-balancer algorithms</a>
</li>
                                    
<li>
    <a href="../cmd-dev/" class="dropdown-item">Developer's guide to loxicmd</a>
</li>
                                    
<li>
    <a href="../api-dev/" class="dropdown-item">Developer's guide to loxilb API</a>
</li>
                                    
<li>
    <a href="../perf/" class="dropdown-item">Performance Report</a>
</li>
                                    
<li>
    <a href="../roadmap/" class="dropdown-item">Development Roadmap</a>
</li>
                                    
<li>
    <a href="../contribute/" class="dropdown-item">Contribution Guide</a>
</li>
                                    
<li>
    <a href="../requirements/" class="dropdown-item">System Requirements</a>
</li>
                                    
<li>
    <a href="../faq/" class="dropdown-item">Frequenctly Asked Questions- FAQs</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Blogs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="https://www.loxilb.io/post/loxilb-cluster-networking-elevating-k8s-networking-capabilities" class="dropdown-item">K8s - Elevating Cluster Networking</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/state-synchronization-of-ebpf-maps-using-go-a-tale-of-two-frameworks" class="dropdown-item">eBPF - Map Sync using Go</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/k8s-nuances-of-in-cluster-external-service-lb-with-loxilb" class="dropdown-item">K8s in-cluster service LB with LoxiLB</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/k8s-introducing-sctp-multihoming-functionality-with-loxilb" class="dropdown-item">K8s - Introducing SCTP Multihoming with LoxiLB</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/loxilb-anycast-service-load-balancing-with-high-availability" class="dropdown-item">Hyperscale anycast load balancing with HA</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/loxilb-load-balancer-setup-on-eks" class="dropdown-item">Getting started with loxilb on Amazon EKS</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/k8s-deploying-hitless-and-ha-load-balancing" class="dropdown-item">K8s - Deploying hitless Load-Balancing</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/k8s-exposing-ipv4-services-externally-as-ipv6" class="dropdown-item">Ipv6 migration in Kubernetes made easy</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/running-loxilb-on-aws-graviton2-based-ec2-instance" class="dropdown-item">Load-balancer Perf comparison on Amazon Graviton2</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Community Posts</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="https://futuredon.medium.com/5g-sctp-loadbalancer-using-loxilb-b525198a9103" class="dropdown-item">5G SCTP LoadBalancer Using loxilb</a>
</li>
            
<li>
    <a href="https://futuredon.medium.com/5g-uplink-classifier-using-loxilb-7593a4d66f4c" class="dropdown-item">5G Uplink Classifier Using loxilb</a>
</li>
            
<li>
    <a href="https://cloudybytes.medium.com/k3s-using-loxilb-as-external-service-lb-2ea4ce61e159" class="dropdown-item">K3s - Using loxilb as external service lb</a>
</li>
            
<li>
    <a href="https://medium.com/@ben0978327139/5g-sctp-loadbalancer-using-loxilb-applying-on-free5gc-b5c05bb723f0" class="dropdown-item">5G SCTP LoadBalancer Using LoxiLB Applying on free5GC</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item">
                                <a rel="prev" href="../code/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../nat/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#loxilb-ebpf-implementation-details" class="nav-link">loxilb eBPF implementation details</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#loading-of-loxilb-ebpf-program" class="nav-link">Loading of loxilb eBPF program</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#entry-points-of-loxilb-ebpf" class="nav-link">Entry points of loxilb eBPF</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#pinned-maps-of-loxilb-ebpf" class="nav-link">Pinned Maps of loxilb eBPF</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#loxilb-ebpf-pipeline-at-a-glance" class="nav-link">loxilb eBPF pipeline at a glance</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="loxilb-ebpf-implementation-details">loxilb eBPF implementation details</h1>
<p>In this section, we will look into details of loxilb ebpf implementation in little details and try to check what goes on under the hood. When loxilb is build, it builds two object files as follows :</p>
<pre><code>llb@nd2:~/loxilb$ ls -l /opt/loxilb/
total 396
drwxrwxrwt 3 root root    0  6?? 20 11:17 dp
-rw-rw-r-- 1 llb llb 305536  6?? 29 09:39 llb_ebpf_main.o
-rw-rw-r-- 1 llb llb  95192  6?? 29 09:39 llb_xdp_main.o
</code></pre>
<p>As the name suggests and based on hook point, <em>xdp</em> version does XDP packet processing while <em>ebpf</em> version is used at TC layer for TC eBPF processing. Interesting enough, the packet forwarding code is largely agnostic of its final hook point due to usage of a light abstraction layer to hide differences between eBPF and XDP layer.</p>
<p>Now this beckons the question why separate hook points and how does it all work together ? loxilb does bulk of its processing at TC eBPF layer as this layer is most optimized for doing L4+ processing needed for loxilb operation. XDP's frame format is different than what is used by skb (linux kernel's generic socket buffer). This makes it very difficult (if not impossible) to do tcp checksum offload and other such features used by linux networking stack for quite some time now. In short, if we need to do such operations, XDP performance will be inherently slow. XDP as such is perfect for quick operations at l2 layer. loxilb uses XDP to do certain operations like mirroring. Due to how TC eBPF works, it is difficult to work with multiple packet copies and loxilb's TC eBPF offloads some functinality to XDP layer in such special cases.</p>
<p><img alt="base" src="../photos/base.png" /></p>
<h2 id="loading-of-loxilb-ebpf-program">Loading of loxilb eBPF program</h2>
<p>loxilb's goLang based agent by default loads the loxilb ebpf programs in all the interfaces(only physical/real/bond/wireguard) available in the system. As loxilb is designed to run in its own docker/container, this is convenient for users who dont want to have to manually load/unload eBPF programs. However, it is still possible to do so manually if need arises :</p>
<p>To load :</p>
<pre><code>ntc filter add dev eth1 ingress bpf da obj /opt/loxilb/llb_ebpf_main.o sec tc_packet_hook0
</code></pre>
<p>To unload:</p>
<pre><code>ntc filter del dev eth1 ingress
</code></pre>
<p>To check:</p>
<pre><code>root@nd2:/home/llb# ntc filter show dev eth1 ingress
filter protocol all pref 49152 bpf chain 0 
filter protocol all pref 49152 bpf chain 0 handle 0x1 llb_ebpf_main.o:[tc_packet_hook0] direct-action not_in_hw id 8715 tag 43a829222e969bce jited 
</code></pre>
<p><em>Please not that <b>ntc</b> is the customized tc tool from iproute2 package which can be found in loxilb's repository</em></p>
<h2 id="entry-points-of-loxilb-ebpf">Entry points of loxilb eBPF</h2>
<p>loxilb's eBPF code is usually divided into two program sections with the following entry functions :</p>
<ul>
<li>tc_packet_func</li>
</ul>
<p>This alongwith the consequent code does majority of the packet processing. If conntrack entries are in established state, this is also responsible for packet tx. However if conntrack entry for a particular packet flow is not established, it makes a bpf tail call to the <em>tc_packet_func_slow</em></p>
<ul>
<li>tc_packet_func_slow</li>
</ul>
<p>This is responsible mainly for doing NAT lookup and stateful conntrack implementation. Once conntrack entry transitions to established state, the forwarding then can happen directly from tc_packet_func</p>
<p>loxilb's XDP code is contained in the following section :</p>
<ul>
<li>xdp_packet_func</li>
</ul>
<p>This is the entry point for packet processing when hook point is XDP instead of TC eBPF</p>
<h2 id="pinned-maps-of-loxilb-ebpf">Pinned Maps of loxilb eBPF</h2>
<p>All maps used by loxilb eBPF are mounted in the file-system as below :</p>
<pre><code>root@nd2:/home/llb/loxilb# ls -lart /opt/loxilb/dp/
total 4
drwxrwxrwt 3 root root    0  6?? 20 11:17 .
drwxr-xr-x 3 root root 4096  6?? 29 10:19 ..
drwx------ 3 root root    0  6?? 29 10:19 bpf
root@nd2:/home/llb/loxilb# mount | grep bpf
none on /opt/netlox/loxilb type bpf (rw,relatime)

root@nd2:/home/llb/loxilb# ls -lart /opt/loxilb/dp/bpf/
total 0
drwxrwxrwt 3 root root 0  6?? 20 11:17 ..
lrwxrwxrwx 1 root root 0  6?? 20 11:17 xdp -&gt; /opt/loxilb/dp/bpf//tc/
drwx------ 3 root root 0  6?? 20 11:17 tc
lrwxrwxrwx 1 root root 0  6?? 20 11:17 ip -&gt; /opt/loxilb/dp/bpf//tc/
-rw------- 1 root root 0  6?? 29 10:19 xfis
-rw------- 1 root root 0  6?? 29 10:19 xfck
-rw------- 1 root root 0  6?? 29 10:19 xctk
-rw------- 1 root root 0  6?? 29 10:19 tx_intf_stats_map
-rw------- 1 root root 0  6?? 29 10:19 tx_intf_map
-rw------- 1 root root 0  6?? 29 10:19 tx_bd_stats_map
-rw------- 1 root root 0  6?? 29 10:19 tmac_stats_map
-rw------- 1 root root 0  6?? 29 10:19 tmac_map
-rw------- 1 root root 0  6?? 29 10:19 smac_map
-rw------- 1 root root 0  6?? 29 10:19 rt_v6_stats_map
-rw------- 1 root root 0  6?? 29 10:19 rt_v4_stats_map
-rw------- 1 root root 0  6?? 29 10:19 rt_v4_map
-rw------- 1 root root 0  6?? 29 10:19 polx_map
-rw------- 1 root root 0  6?? 29 10:19 pkts
-rw------- 1 root root 0  6?? 29 10:19 pkt_ring
-rw------- 1 root root 0  6?? 29 10:19 pgm_tbl
-rw------- 1 root root 0  6?? 29 10:19 nh_map
-rw------- 1 root root 0  6?? 29 10:19 nat_v4_map
-rw------- 1 root root 0  6?? 29 10:19 mirr_map
-rw------- 1 root root 0  6?? 29 10:19 intf_stats_map
-rw------- 1 root root 0  6?? 29 10:19 intf_map
-rw------- 1 root root 0  6?? 29 10:19 fc_v4_stats_map
-rw------- 1 root root 0  6?? 29 10:19 fc_v4_map
-rw------- 1 root root 0  6?? 29 10:19 fcas
-rw------- 1 root root 0  6?? 29 10:19 dmac_map
-rw------- 1 root root 0  6?? 29 10:19 ct_v4_map
-rw------- 1 root root 0  6?? 29 10:19 bd_stats_map
-rw------- 1 root root 0  6?? 29 10:19 acl_v6_stats_map
-rw------- 1 root root 0  6?? 29 10:19 acl_v4_stats_map
-rw------- 1 root root 0  6?? 29 10:19 acl_v4_map
</code></pre>
<p>Using bpftool, it is easy to check state of these maps as follows :</p>
<pre><code>root@nd2:/home/llb# bpftool map dump pinned /opt/loxilb/dp/bpf/intf_map 
[{
        &quot;key&quot;: {
            &quot;ifindex&quot;: 2,
            &quot;ing_vid&quot;: 0,
            &quot;pad&quot;: 0
        },
        &quot;value&quot;: {
            &quot;ca&quot;: {
                &quot;act_type&quot;: 11,
                &quot;ftrap&quot;: 0,
                &quot;oif&quot;: 0,
                &quot;cidx&quot;: 0
            },
            &quot;&quot;: {
                &quot;set_ifi&quot;: {
                    &quot;xdp_ifidx&quot;: 1,
                    &quot;zone&quot;: 0,
                    &quot;bd&quot;: 3801,
                    &quot;mirr&quot;: 0,
                    &quot;polid&quot;: 0,
                    &quot;r&quot;: [0,0,0,0,0,0
                    ]
                }
            }
        }
    },{
        &quot;key&quot;: {
            &quot;ifindex&quot;: 3,
            &quot;ing_vid&quot;: 0,
            &quot;pad&quot;: 0
        },
        &quot;value&quot;: {
            &quot;ca&quot;: {
                &quot;act_type&quot;: 11,
                &quot;ftrap&quot;: 0,
                &quot;oif&quot;: 0,
                &quot;cidx&quot;: 0
            },
            &quot;&quot;: {
                &quot;set_ifi&quot;: {
                    &quot;xdp_ifidx&quot;: 3,
                    &quot;zone&quot;: 0,
                    &quot;bd&quot;: 3803,
                    &quot;mirr&quot;: 0,
                    &quot;polid&quot;: 0,
                    &quot;r&quot;: [0,0,0,0,0,0
                    ]
                }
            }
        }
    }
]
</code></pre>
<p>As our development progresses, we will keep updating details about these map's internals</p>
<h2 id="loxilb-ebpf-pipeline-at-a-glance">loxilb eBPF pipeline at a glance</h2>
<p>The following figure shows a very high-level diagram of packet flow through loxilb  eBPF pipeline :</p>
<p><img alt="pipe" src="../photos/pipe.png" /></p>
<p>We use eBPF tail calls to jump from one section to another majorly due to the fact that there is clear separation for CT (conntrack) functionality and packet-forwarding logic. At the same time, since kernel's built in eBPF-verifier imposes a maximum code size limit for a single program/section, it also helps to circumvent this issue.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
