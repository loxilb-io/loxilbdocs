<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://loxilb-io.github.io/loxilbdocs/k3s-multi-master/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>How-To - Deploy multi-server K3s HA with loxilb - loxilb v0.9.5</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../stylesheets/extra.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-21G7NBL2BN"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', "G-21G7NBL2BN");
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">loxilb v0.9.5</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Architectural Considerations</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../kube-loxilb/" class="dropdown-item">Understanding loxilb deployment in K8s with kube-loxilb</a>
</li>
                                    
<li>
    <a href="../ha-deploy/" class="dropdown-item">Understanding High-availability with loxilb</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Getting Started</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../k3s_quick_start_flannel/" class="dropdown-item">ext-cluster pod - K3s/loxilb with default flannel</a>
</li>
                                    
<li>
    <a href="../k3s_quick_start_calico/" class="dropdown-item">ext-cluster pod - K3s/loxilb with calico</a>
</li>
                                    
<li>
    <a href="../quick_start_with_cilium/" class="dropdown-item">ext-cluster pod - K3s/loxilb with cilium</a>
</li>
                                    
<li>
    <a href="../k0s_quick_start/" class="dropdown-item">ext-cluster pod - K0s/loxilb with kube-router</a>
</li>
                                    
<li>
    <a href="../k3s_quick_start_incluster/" class="dropdown-item">in-cluster pod - K3s/loxilb in-cluster mode</a>
</li>
                                    
<li>
    <a href="../k0s_quick_start_incluster/" class="dropdown-item">in-cluster pod - K0s/loxilb in-cluster mode</a>
</li>
                                    
<li>
    <a href="../microk8s_quick_start_incluster/" class="dropdown-item">in-cluster pod - MicroK8s/loxilb in-cluster mode</a>
</li>
                                    
<li>
    <a href="../service-proxy-flannel/" class="dropdown-item">service-proxy - K3s/loxilb service-proxy with flannel</a>
</li>
                                    
<li>
    <a href="../service-proxy-calico/" class="dropdown-item">service-proxy - K3s/loxilb service-proxy with calico</a>
</li>
                                    
<li>
    <a href="../standalone/" class="dropdown-item">loxilb in standalone mode</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Advanced Guides</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../service-zones/" class="dropdown-item">How-To - service-group zones</a>
</li>
                                    
<li>
    <a href="../ext-ep/" class="dropdown-item">How-To - access end-points outside K8s</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">How-To - Deploy multi-server K3s HA with loxilb</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Knowledge Base</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ebpf/" class="dropdown-item">What is eBPF</a>
</li>
                                    
<li>
    <a href="../lb/" class="dropdown-item">What is k8s service - load-balancer</a>
</li>
                                    
<li>
    <a href="../arch/" class="dropdown-item">Architecture in brief</a>
</li>
                                    
<li>
    <a href="../code/" class="dropdown-item">Code organization</a>
</li>
                                    
<li>
    <a href="../loxilbebpf/" class="dropdown-item">eBPF internals</a>
</li>
                                    
<li>
    <a href="../nat/" class="dropdown-item">NAT Modes of loxilb</a>
</li>
                                    
<li>
    <a href="../lb-algo/" class="dropdown-item">loxilb load-balancer algorithms</a>
</li>
                                    
<li>
    <a href="../run/" class="dropdown-item">Manual steps to build/run</a>
</li>
                                    
<li>
    <a href="../debugging/" class="dropdown-item">Debugging loxilb</a>
</li>
                                    
<li>
    <a href="../cmd-dev/" class="dropdown-item">Developer's guide to loxicmd</a>
</li>
                                    
<li>
    <a href="../api-dev/" class="dropdown-item">Developer's guide to loxilb API</a>
</li>
                                    
<li>
    <a href="../api/" class="dropdown-item">loxilb api-reference</a>
</li>
                                    
<li>
    <a href="../perf/" class="dropdown-item">Performance Report</a>
</li>
                                    
<li>
    <a href="../roadmap/" class="dropdown-item">Development Roadmap</a>
</li>
                                    
<li>
    <a href="../contribute/" class="dropdown-item">Contribution Guide</a>
</li>
                                    
<li>
    <a href="../requirements/" class="dropdown-item">System Requirements</a>
</li>
                                    
<li>
    <a href="../faq/" class="dropdown-item">Frequenctly Asked Questions- FAQs</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Blogs</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="https://www.loxilb.io/post/loxilb-cluster-networking-elevating-k8s-networking-capabilities" class="dropdown-item">K8s - Elevating Cluster Networking</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/state-synchronization-of-ebpf-maps-using-go-a-tale-of-two-frameworks" class="dropdown-item">eBPF - Map Sync using Go</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/k8s-nuances-of-in-cluster-external-service-lb-with-loxilb" class="dropdown-item">K8s in-cluster service LB with LoxiLB</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/k8s-introducing-sctp-multihoming-functionality-with-loxilb" class="dropdown-item">K8s - Introducing SCTP Multihoming with LoxiLB</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/loxilb-anycast-service-load-balancing-with-high-availability" class="dropdown-item">Hyperscale anycast load balancing with HA</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/loxilb-load-balancer-setup-on-eks" class="dropdown-item">Getting started with loxilb on Amazon EKS</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/k8s-deploying-hitless-and-ha-load-balancing" class="dropdown-item">K8s - Deploying hitless Load-Balancing</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/k8s-exposing-ipv4-services-externally-as-ipv6" class="dropdown-item">Ipv6 migration in Kubernetes made easy</a>
</li>
                                    
<li>
    <a href="https://www.loxilb.io/post/running-loxilb-on-aws-graviton2-based-ec2-instance" class="dropdown-item">Load-balancer Perf comparison on Amazon Graviton2</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Community Posts</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="https://futuredon.medium.com/5g-sctp-loadbalancer-using-loxilb-b525198a9103" class="dropdown-item">5G SCTP LoadBalancer Using loxilb</a>
</li>
            
<li>
    <a href="https://futuredon.medium.com/5g-uplink-classifier-using-loxilb-7593a4d66f4c" class="dropdown-item">5G Uplink Classifier Using loxilb</a>
</li>
            
<li>
    <a href="https://cloudybytes.medium.com/k3s-using-loxilb-as-external-service-lb-2ea4ce61e159" class="dropdown-item">K3s - Using loxilb as external service lb</a>
</li>
            
<li>
    <a href="https://medium.com/@ben0978327139/5g-sctp-loadbalancer-using-loxilb-applying-on-free5gc-b5c05bb723f0" class="dropdown-item">5G SCTP LoadBalancer Using LoxiLB Applying on free5GC</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                            <li class="nav-item">
                                <a rel="prev" href="../ext-ep/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../ebpf/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            
            
            
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h3 id="guide-to-deploy-multi-master-ha-k3s-with-loxilb">Guide to deploy multi-master HA K3s with loxilb</h3>
<p>This document will explain how to install a multi-master HA K3s cluster with loxilb as a serviceLB provider running in-cluster mode. K3s is a lightweight Kubernetes distribution and is increasingly used for prototyping as well as for production workloads. K3s nodes are deployed as 1) k3s-server nodes for k3s control plane components like apiserver and etcd, 2) k3s-agent nodes hosting user workloads/apps. When we deploy multi-master nodes, it is necessary that they be accessed from the k3s-agents in HA configuration and behind a load-balancer. Usually deploying such a load-balancer is <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">outside the scope</a> of kubernetes. In this guide, we will see how to deploy loxilb not only as cluster's serviceLB provider but also as a VIP-LB for accessing server/master node(s) services.      </p>
<h3 id="topology">Topology</h3>
<p>For multi-master setup we need an odd number of server nodes to maintain quorum. So, we will have 3 k3s-server nodes for this setup. Overall, we will be deploying the components as per the following topology :   </p>
<p><img alt="loxilb topology" src="../photos/loxilb-k3s-multi-master.png" /></p>
<h3 id="k3s-installation-and-setup">K3s installation and Setup</h3>
<h4 id="in-k3s-server1-node-">In k3s-server1 node -</h4>
<pre><code>$ curl -fL https://get.k3s.io | sh -s - server --node-ip=192.168.80.10 \
  --disable servicelb --disable traefik --cluster-init external-hostname=192.168.80.10 \
  --node-external-ip=192.168.80.80 --disable-cloud-controller
</code></pre>
<p>It is to be noted that <code>--node-external-ip=192.168.80.80</code> is used since we will utilize 192.168.80.80 as the VIP to access the multi-master setup from k3s-agents and other clients.</p>
<h5 id="setup-the-node-for-loxilb">Setup the node for loxilb :</h5>
<pre><code>sudo mkdir -p /etc/loxilb
</code></pre>
<p>Create the following files in /etc/loxilb</p>
<ol>
<li>lbconfig.txt with following contents (change as per your requirement)</li>
</ol>
<pre><code>{
   &quot;lbAttr&quot;:[
      {
         &quot;serviceArguments&quot;:{
            &quot;externalIP&quot;:&quot;192.168.80.80&quot;,
            &quot;port&quot;:6443,
            &quot;protocol&quot;:&quot;tcp&quot;,
            &quot;sel&quot;:0,
            &quot;mode&quot;:2,
            &quot;BGP&quot;:false,
            &quot;Monitor&quot;:true,
            &quot;inactiveTimeOut&quot;:240,
            &quot;block&quot;:0
         },
         &quot;secondaryIPs&quot;:null,
         &quot;endpoints&quot;:[
            {
               &quot;endpointIP&quot;:&quot;192.168.80.10&quot;,
               &quot;targetPort&quot;:6443,
               &quot;weight&quot;:1,
               &quot;state&quot;:&quot;active&quot;,
               &quot;counter&quot;:&quot;&quot;
            },
            {
               &quot;endpointIP&quot;:&quot;192.168.80.11&quot;,
               &quot;targetPort&quot;:6443,
               &quot;weight&quot;:1,
               &quot;state&quot;:&quot;active&quot;,
               &quot;counter&quot;:&quot;&quot;
            },
            {
               &quot;endpointIP&quot;:&quot;192.168.80.12&quot;,
               &quot;targetPort&quot;:6443,
               &quot;weight&quot;:1,
               &quot;state&quot;:&quot;active&quot;,
               &quot;counter&quot;:&quot;&quot;
            }
         ]
      }
   ]
}

</code></pre>
<ol>
<li>EPconfig.txt with the following contents (change as per your requirement)</li>
</ol>
<pre><code>{
   &quot;Attr&quot;:[
      {
         &quot;hostName&quot;:&quot;192.168.80.10&quot;,
         &quot;name&quot;:&quot;192.168.80.10_tcp_6443&quot;,
         &quot;inactiveReTries&quot;:2,
         &quot;probeType&quot;:&quot;tcp&quot;,
         &quot;probeReq&quot;:&quot;&quot;,
         &quot;probeResp&quot;:&quot;&quot;,
         &quot;probeDuration&quot;:10,
         &quot;probePort&quot;:6443
      },
      {
         &quot;hostName&quot;:&quot;192.168.80.11&quot;,
         &quot;name&quot;:&quot;192.168.80.11_tcp_6443&quot;,
         &quot;inactiveReTries&quot;:2,
         &quot;probeType&quot;:&quot;tcp&quot;,
         &quot;probeReq&quot;:&quot;&quot;,
         &quot;probeResp&quot;:&quot;&quot;,
         &quot;probeDuration&quot;:10,
         &quot;probePort&quot;:6443
      },
      {
         &quot;hostName&quot;:&quot;192.168.80.12&quot;,
         &quot;name&quot;:&quot;192.168.80.12_tcp_6443&quot;,
         &quot;inactiveReTries&quot;:2,
         &quot;probeType&quot;:&quot;tcp&quot;,
         &quot;probeReq&quot;:&quot;&quot;,
         &quot;probeResp&quot;:&quot;&quot;,
         &quot;probeDuration&quot;:10,
         &quot;probePort&quot;:6443
      }
   ]
}
</code></pre>
<p>The above serve as bootstrap LB rules for load-balancing into the k3s-server nodes as we will see later.  </p>
<h4 id="in-k3s-server2-node-">In k3s-server2 node -</h4>
<pre><code>$ curl -fL https://get.k3s.io | K3S_TOKEN=${NODE_TOKEN} sh -s - server --server https://192.168.80.10:6443 \
  --disable traefik --disable servicelb --node-ip=192.168.80.11 \
  external-hostname=192.168.80.11 --node-external-ip=192.168.80.80 -t ${NODE_TOKEN}
</code></pre>
<p>where NODE_TOKEN contain simply contents of /var/lib/rancher/k3s/server/node-token from server1. For example, it can be set using a command equivalent to the following :</p>
<pre><code>export NODE_TOKEN=$(cat node-token)
</code></pre>
<h5 id="setup-the-node-for-loxilb_1">Setup the node for loxilb:</h5>
<p>Simply follow the steps as outlined for server1.</p>
<h4 id="in-k3s-server3-node-">In k3s-server3 node -</h4>
<pre><code>$ curl -fL https://get.k3s.io | K3S_TOKEN=${NODE_TOKEN} sh -s - server --server https://192.168.80.10:6443 \
  --disable traefik --disable servicelb --node-ip=192.168.80.12 \
  external-hostname=192.168.80.12 --node-external-ip=192.168.80.80 -t ${NODE_TOKEN}
</code></pre>
<p>where NODE_TOKEN contain simply contents of /var/lib/rancher/k3s/server/node-token from server1. For example, it can be set using a command equivalent to the following :</p>
<pre><code>export NODE_TOKEN=$(cat node-token)
</code></pre>
<h5 id="setup-the-node-for-loxilb_2">Setup the node for loxilb:</h5>
<p>First, follow the steps as outlined for server1. Additionally, we will have to start loxilb pod instances as follows :</p>
<pre><code>$ sudo kubectl apply -f - &lt;&lt;EOF
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: loxilb-lb
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: loxilb-app
  template:
    metadata:
      name: loxilb-lb
      labels:
        app: loxilb-app
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      tolerations:
      - key: &quot;node-role.kubernetes.io/master&quot;
        operator: Exists
      - key: &quot;node-role.kubernetes.io/control-plane&quot;
        operator: Exists
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: &quot;node-role.kubernetes.io/master&quot;
                operator: Exists
              - key: &quot;node-role.kubernetes.io/control-plane&quot;
                operator: Exists
      volumes:
      - name: hllb
        hostPath:
          path: /etc/loxilb
          type: DirectoryOrCreate
      containers:
      - name: loxilb-app
        image: &quot;ghcr.io/loxilb-io/loxilb:latest&quot;
        imagePullPolicy: Always
        command:
        - /root/loxilb-io/loxilb/loxilb
        args:
        - --egr-hooks
        - --blacklist=cni[0-9a-z]|veth.|flannel.
        volumeMounts:
        - name: hllb
          mountPath: /etc/loxilb
        ports:
        - containerPort: 11111
        - containerPort: 179
        securityContext:
          privileged: true
          capabilities:
            add:
              - SYS_ADMIN
---
apiVersion: v1
kind: Service
metadata:
  name: loxilb-lb-service
  namespace: kube-system
spec:
  clusterIP: None
  selector:
    app: loxilb-app
  ports:
  - name: loxilb-app
    port: 11111
    targetPort: 11111
    protocol: TCP
EOF
</code></pre>
<p>Kindly note that the args for loxilb might change depending on the scenario. This scenario considers loxilb running in-cluster mode. For service-proxy mode, please follow this <a href="https://raw.githubusercontent.com/loxilb-io/kube-loxilb/main/manifest/service-proxy/loxilb-service-proxy.yml">yaml</a> for exact args. Next, we will install loxilb's operator kube-loxilb as follows :</p>
<pre><code>$ sudo kubectl apply -f - &lt;&lt;EOF
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-loxilb
  namespace: kube-system
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: kube-loxilb
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes
    verbs:
      - get
      - watch
      - list
      - patch
  - apiGroups:
      - &quot;&quot;
    resources:
      - pods
    verbs:
      - get
      - watch
      - list
      - patch
  - apiGroups:
      - &quot;&quot;
    resources:
      - endpoints
      - services
      - services/status
    verbs:
      - get
      - watch
      - list
      - patch
      - update
  - apiGroups:
      - discovery.k8s.io
    resources:
      - endpointslices
    verbs:
     - get
      - watch
      - list
  - apiGroups:
      - authentication.k8s.io
    resources:
      - tokenreviews
    verbs:
      - create
  - apiGroups:
      - authorization.k8s.io
    resources:
      - subjectaccessreviews
    verbs:
      - create
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: kube-loxilb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-loxilb
subjects:
  - kind: ServiceAccount
    name: kube-loxilb
    namespace: kube-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kube-loxilb
  namespace: kube-system
  labels:
    app: loxilb
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loxilb
  template:
    metadata:
      labels:
        app: loxilb
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      tolerations:
        - effect: NoSchedule
          operator: Exists
        # Mark the pod as a critical add-on for rescheduling.
        - key: CriticalAddonsOnly
          operator: Exists
        - effect: NoExecute
          operator: Exists
        - key: &quot;node-role.kubernetes.io/master&quot;
          operator: Exists
        - key: &quot;node-role.kubernetes.io/control-plane&quot;
          operator: Exists
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: &quot;node-role.kubernetes.io/master&quot;
                operator: Exists
              - key: &quot;node-role.kubernetes.io/control-plane&quot;
                operator: Exists
      priorityClassName: system-node-critical
      serviceAccountName: kube-loxilb
      terminationGracePeriodSeconds: 0
      containers:
      - name: kube-loxilb
        image: ghcr.io/loxilb-io/kube-loxilb:latest
        imagePullPolicy: Always
        command:
        - /bin/kube-loxilb
        args:
        - --externalCIDR=192.168.80.200/32
        - --setRoles=0.0.0.0
        resources:
          requests:
            cpu: &quot;100m&quot;
            memory: &quot;50Mi&quot;
          limits:
            cpu: &quot;100m&quot;
            memory: &quot;50Mi&quot;
       securityContext:
          privileged: true
          capabilities:
            add: [&quot;NET_ADMIN&quot;, &quot;NET_RAW&quot;]
EOF
</code></pre>
<p>At this point we can check the pods running in our kubernetes cluster (in server1, server2 &amp; server3 at this point):</p>
<pre><code>$ sudo kubectl get pods -A
NAMESPACE     NAME                                      READY   STATUS    RESTARTS   AGE
kube-system   coredns-6799fbcd5-7jhcx                   1/1     Running   0          3h15m
kube-system   kube-loxilb-5d99c445f7-j4x6k              1/1     Running   0          3h6m
kube-system   local-path-provisioner-6c86858495-pjn9j   1/1     Running   0          3h15m
kube-system   loxilb-lb-8bddf                           1/1     Running   0          3h6m
kube-system   loxilb-lb-nsrr9                           1/1     Running   0          3h6m
kube-system   loxilb-lb-fp2z6                           1/1     Running   0          3h6m
kube-system   metrics-server-54fd9b65b-g5lfn            1/1     Running   0          3h15m
</code></pre>
<h4 id="in-k3s-agent1-node-">In k3s-agent1 node -</h4>
<p>The following steps need to be followed to install k3s in the agent nodes:</p>
<pre><code>$ curl -sfL https://get.k3s.io | K3S_TOKEN=${NODE_TOKEN} sh -s - agent --server https://192.168.80.80:6443 --node-ip=${WORKER_ADDR} --node-external-ip=${WORKER_ADDR} -t ${NODE_TOKEN}
</code></pre>
<p>where WORKER_ADDR is the IP  address of the agent node itself (in this case 192.168.80.101) and NODE_TOKEN has contents of /var/lib/rancher/k3s/server/node-token from server1. </p>
<p>It is also to be noted that we use VIP - 192.168.80.80 provided by loxilb to access the server(master) K3s nodes and not the actual private node addresses.</p>
<p>For rest of the agent nodes, we can follow the same set of steps as outlined above for k3s-agent1.</p>
<h3 id="validation">Validation</h3>
<p>After setting up all the k3s-server and k3s-agents, we should be able to see all nodes up and running </p>
<pre><code>$ sudo kubectl get nodes -A
NAME      STATUS   ROLES                       AGE   VERSION
master1   Ready    control-plane,etcd,master   4h    v1.29.3+k3s1
master2   Ready    control-plane,etcd,master   4h    v1.29.3+k3s1
master3   Ready    control-plane,etcd,master   4h    v1.29.3+k3s1 
worker1   Ready    &lt;none&gt;                      4h    v1.29.3+k3s1
worker2   Ready    &lt;none&gt;                      4h    v1.29.3+k3s1
worker3   Ready    &lt;none&gt;                      4h    v1.29.3+k3s1
</code></pre>
<p>To verify, let's shutdown master1 k3s-server. </p>
<pre><code>## Run shutdown the master1 node
$ sudo shutdown -t now
</code></pre>
<p>And try to access cluster information from other master nodes or worker nodes :</p>
<pre><code>$ sudo kubectl get nodes -A
NAME      STATUS     ROLES                       AGE      VERSION
master1   NotReady   control-plane,etcd,master   4h10m    v1.29.3+k3s1
master2   Ready      control-plane,etcd,master   4h10m    v1.29.3+k3s1
master3   Ready      control-plane,etcd,master   4h10m    v1.29.3+k3s1
worker1   Ready      &lt;none&gt;                      4h10m    v1.29.3+k3s1
worker2   Ready      &lt;none&gt;                      4h10m    v1.29.3+k3s1
</code></pre>
<p>Also, we can confirm pods getting rescheduled to other "ready" nodes : </p>
<pre><code>$ sudo kubectl get pods -A -o wide
NAMESPACE     NAME                                      READY   STATUS        RESTARTS   AGE     IP              NODE      NOMINATED NODE   READINESS GATES
kube-system   coredns-6799fbcd5-6dvm7                   1/1     Running       0          27m     10.42.2.2       master3   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-6799fbcd5-mrjgt                   1/1     Terminating   0          3h58m   10.42.0.4       master1   &lt;none&gt;           &lt;none&gt;
kube-system   kube-loxilb-5d99c445f7-x7qd6              1/1     Running       0          3h58m   192.168.80.11   master2   &lt;none&gt;           &lt;none&gt;
kube-system   local-path-provisioner-6c86858495-6f8rz   1/1     Terminating   0          3h58m   10.42.0.2       master1   &lt;none&gt;           &lt;none&gt;
kube-system   local-path-provisioner-6c86858495-z2p6m   1/1     Running       0          27m     10.42.3.2       worker1   &lt;none&gt;           &lt;none&gt;
kube-system   loxilb-lb-65jnz                           1/1     Running       0          3h58m   192.168.80.10   master1   &lt;none&gt;           &lt;none&gt;
kube-system   loxilb-lb-pfkf8                           1/1     Running       0          3h58m   192.168.80.12   master3   &lt;none&gt;           &lt;none&gt;
kube-system   loxilb-lb-xhr95                           1/1     Running       0          3h58m   192.168.80.11   master2   &lt;none&gt;           &lt;none&gt;
kube-system   metrics-server-54fd9b65b-l5pqz            1/1     Running       0          27m     10.42.4.2       worker2   &lt;none&gt;           &lt;none&gt;
kube-system   metrics-server-54fd9b65b-x9bd7            1/1     Terminating   0          3h58m   10.42.0.3       master1   &lt;none&gt;           &lt;none&gt;
</code></pre>
<p>If the above set of command works fine in any of the "ready" nodes, it indicates that the api server is available even when one of k3s server (master) goes down. The same can be followed if need be for any services apart from K8s/K3s apiserver as well. </p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
